<!DOCTYPE HTML>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Your Website</title>
  <link rel="stylesheet" type="text/css" href="css/reset.css">
  <link rel="stylesheet" type="text/css" href="css/app.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
  <script src="js/jquery.nicescroll.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.2/js/select2.min.js"></script>


</head>

<body>

  <div id="map"></div>

  <div class="box">
    <div class="box-inner">
      <div class="box-header">
        <div class="box-select">
          <h2 class="box-selectTitle">CHOOSE A MEASUREMENT</h2>
          <div class="box-input">
            <h2 class="js-box-input">All</h2>
          </div>
        </div>  
        <div class="box-select">
          <h2 class="box-selectTitle js-box-selectTitle">MALE POPULATION</h2>
          <div class="box-selectInfo">
            <div class="box-icon">
                            <!-- all -->
              <svg class="all" width="28px" height="29px" viewBox="0 0 28 29" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                  <defs></defs>
                  <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                      <g id="-Icons" transform="translate(-95.000000, -82.000000)" fill="#2E3C43">
                          <path d="M122.722435,97.971917 L116.913043,94.1831502 L116.913043,86.5787546 C116.913043,86.3540904 116.790087,86.1477411 116.594087,86.042735 L109.289739,82.0732601 C109.109565,81.97558 108.890435,81.97558 108.709043,82.0732601 L101.404696,86.042735 C101.209913,86.1477411 101.086957,86.3540904 101.086957,86.5787546 L101.086957,94.1831502 L95.2775652,97.971917 C95.1034783,98.0842491 95,98.2771673 95,98.4835165 L95,106.421245 C95,106.627595 95.1034783,106.820513 95.2775652,106.932845 L101.364522,110.901099 C101.464348,110.967033 101.58,111 101.695652,111 C101.795478,111 101.895304,110.97558 101.985391,110.925519 L109,107.114774 L116.014609,110.925519 C116.104696,110.97558 116.204522,111 116.304348,111 C116.42,111 116.535652,110.967033 116.635478,110.901099 L122.722435,106.932845 C122.896522,106.820513 123,106.627595 123,106.421245 L123,98.4835165 C123,98.2771673 122.896522,98.0842491 122.722435,97.971917 L122.722435,97.971917 Z M109,83.3028083 L115.695652,86.9413919 L115.695652,94.1501832 L109,97.7887668 L102.304348,94.1501832 L102.304348,86.9426129 L109,83.3028083 L109,83.3028083 Z M101.723652,109.680098 L96.2173913,106.090354 L96.2173913,98.8156288 L101.721217,95.2258852 L108.391304,98.8485958 L108.391304,106.057387 L101.723652,109.680098 L101.723652,109.680098 Z M121.782609,106.090354 L116.276348,109.680098 L109.608696,106.057387 L109.608696,98.8485958 L116.278783,95.2246642 L121.782609,98.8156288 L121.782609,106.090354 L121.782609,106.090354 Z" id="Honeycomb"></path>
                      </g>
                  </g>
              </svg>
              <!-- age -->
              <svg class="age" style="display: none;" width="27px" height="27px" viewBox="0 0 27 27" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                  <defs></defs>
                  <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                      <g id="-Icons" transform="translate(-96.000000, -290.000000)" fill="#2E3C43">
                          <path d="M120,316.047549 C121.624227,316.047549 123,314.716361 123,313.047549 L123,305.047549 L123,302.047549 C123,302.063549 122.725091,301.797549 122,302.047549 L119,302.047549 L119,298.047549 C119.318182,297.313549 119.043273,297.047549 119,297.047549 L116,297.047549 C115.911273,297.047549 115.636364,297.313549 116,298.047549 L116,302.047549 L111,302.047549 L111,298.047549 C110.727273,297.313549 110.452364,297.047549 110,297.047549 L109,297.047549 C108.320364,297.047549 108.045455,297.313549 108,298.047549 L108,302.047549 L103,302.047549 L103,298.047549 C103.363636,297.313549 103.088727,297.047549 103,297.047549 L100,297.047549 C99.9567273,297.047549 99.6818182,297.313549 100,298.047549 L100,302.047549 L97,302.047549 C96.2749091,301.797549 96,302.063549 96,302.047549 L96,305.047549 L96,313.047549 C96,314.716361 97.3757727,316.047549 99,316.047549 L120,316.047549 Z M117,298.047549 L118,298.047549 L118,302.047549 L117,302.047549 L117,298.047549 L117,298.047549 Z M109,298.047549 L110,298.047549 L110,302.047549 L109,302.047549 L109,298.047549 L109,298.047549 Z M101,298.047549 L102,298.047549 L102,302.047549 L101,302.047549 L101,298.047549 L101,298.047549 Z M97,303.047549 L100,303.047549 L103,303.047549 L108,303.047549 L110,303.047549 L116,303.047549 L119,303.047549 L122,303.047549 L122,305.047549 C122,306.653431 120.4425,307.753431 120,308.047549 C118.5575,307.753431 117,306.653431 117,305.047549 C117,305.075784 116.72,304.812255 116,305.047549 C116.03,304.812255 115.75,305.075784 116,305.047549 C115.75,306.826372 114.20375,308.047549 113,308.047549 C111.67125,308.047549 110.125,306.826372 110,305.047549 C110.125,305.075784 109.845,304.812255 110,305.047549 C109.155,304.812255 108.875,305.075784 109,305.047549 C108.875,306.826372 107.32875,308.047549 106,308.047549 C104.79625,308.047549 103.25,306.826372 103,305.047549 C103.25,305.075784 102.97,304.812255 103,305.047549 C102.28,304.812255 102,305.075784 102,305.047549 C102,306.653431 100.4425,307.753431 100,308.047549 C98.5575,307.753431 97,306.653431 97,305.047549 L97,303.047549 L97,303.047549 Z M100,309.047549 C100.4925,308.809246 101.80125,308.12927 103,307.047549 C103.35625,308.296457 104.78125,309.121161 106,309.047549 C107.32125,309.121161 108.71625,308.326401 110,307.047549 C110.28375,308.327649 111.67875,309.121161 113,309.047549 C114.21875,309.121161 115.64375,308.296457 116,307.047549 C117.19875,308.12927 118.5075,308.809246 120,309.047549 C120.27625,308.809246 121.2425,308.388784 122,308.047549 L122,313.047549 C122,314.207873 121.15875,315.047549 120,315.047549 L99,315.047549 C97.84125,315.047549 97,314.207873 97,313.047549 L97,308.047549 C97.7575,308.388784 98.72375,308.809246 100,309.047549 Z M110,296.047549 C110.87875,296.047549 112,294.969478 112,294.047549 C112,292.478016 110.30625,290.60311 110,290.047549 C109.72875,289.98415 109.27125,289.98415 109,290.047549 C108.69375,290.60311 107,292.478016 107,294.047549 C107,294.969478 108.12125,296.047549 110,296.047549 Z M110,292.047549 C110.295,292.777189 111,293.595971 111,294.047549 C111,294.554519 110.328,295.047549 110,295.047549 C108.672,295.047549 108,294.554519 108,294.047549 C108,293.597072 108.705,292.77829 110,292.047549 Z M118,296.047549 C118.87875,296.047549 120,294.969478 120,294.047549 C120,292.478016 118.30625,290.60311 118,290.047549 C117.72875,289.98415 117.27125,289.98415 117,290.047549 C116.69375,290.60311 115,292.478016 115,294.047549 C115,294.969478 116.12125,296.047549 118,296.047549 Z M118,292.047549 C118.295,292.777189 119,293.595971 119,294.047549 C119,294.554519 118.328,295.047549 118,295.047549 C116.672,295.047549 116,294.554519 116,294.047549 C116,293.597072 116.705,292.77829 118,292.047549 Z M102,296.047549 C102.87875,296.047549 104,294.969478 104,294.047549 C104,292.478016 102.30625,290.60311 102,290.047549 C101.72875,289.98415 101.27125,289.98415 101,290.047549 C100.69375,290.60311 99,292.478016 99,294.047549 C99,294.969478 100.12125,296.047549 102,296.047549 Z M102,292.047549 C102.295,292.777189 103,293.595971 103,294.047549 C103,294.554519 102.328,295.047549 102,295.047549 C100.672,295.047549 100,294.554519 100,294.047549 C100,293.597072 100.705,292.77829 102,292.047549 Z" id="brithday-cake"></path>
                      </g>
                  </g>
              </svg>
              <!--households -->
              <svg class="households" style="display: none;" width="29px" height="28px" viewBox="0 0 29 28" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                  <defs></defs>
                  <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                      <g id="-Icons" transform="translate(-94.000000, -540.000000)" fill="#2E3C43">
                          <path d="M118.769927,555.216478 C118.436427,555.216478 118.16576,555.489174 118.16576,555.825174 L118.16576,566.781696 L112.124094,566.781696 L112.124094,558.868652 C112.124094,558.532652 111.853427,558.259957 111.519927,558.259957 L105.47826,558.259957 C105.14476,558.259957 104.874094,558.532652 104.874094,558.868652 L104.874094,566.781696 L98.8324271,566.781696 L98.8324271,555.216478 C98.8324271,554.880478 98.5617604,554.607783 98.2282604,554.607783 C97.8947604,554.607783 97.6240937,554.880478 97.6240937,555.216478 L97.6240937,567.390391 C97.6240937,567.727609 97.8947604,567.999087 98.2282604,567.999087 L105.47826,567.999087 C105.81176,567.999087 106.082427,567.726391 106.082427,567.390391 L106.082427,559.477348 L110.91576,559.477348 L110.91576,567.390391 C110.91576,567.726391 111.186427,567.999087 111.519927,567.999087 L118.769927,567.999087 C119.103427,567.999087 119.374094,567.726391 119.374094,567.390391 L119.374094,555.825174 C119.374094,555.489174 119.103427,555.216478 118.769927,555.216478 Z M122.822677,554.178043 L108.926844,540.178043 C108.691219,539.940652 108.308177,539.940652 108.072552,540.178043 L94.1767188,554.178043 C93.9410937,554.415435 93.9410937,554.801348 94.1767188,555.038739 C94.4123438,555.27613 94.7953854,555.27613 95.0310104,555.038739 L108.499094,541.469696 L121.967177,555.038739 C122.085594,555.158043 122.24026,555.216478 122.394927,555.216478 C122.549594,555.216478 122.70426,555.156826 122.822677,555.038739 C123.058302,554.801348 123.058302,554.415435 122.822677,554.178043 Z M113.332427,542.43387 L116.957427,542.43387 L116.957427,546.086043 C116.957427,546.422043 117.228094,546.694739 117.561594,546.694739 C117.895094,546.694739 118.16576,546.423261 118.16576,546.086043 L118.16576,541.825174 C118.16576,541.489174 117.895094,541.216478 117.561594,541.216478 L113.332427,541.216478 C112.998927,541.216478 112.72826,541.489174 112.72826,541.825174 C112.72826,542.161174 112.998927,542.43387 113.332427,542.43387 Z" id="house"></path>
                      </g>
                  </g>
              </svg>
              <!--income -->
              <svg class="income" style="display: none;" width="19px" height="29px" viewBox="0 0 19 29" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                  <defs></defs>
                  <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                      <g id="-Icons" transform="translate(-99.000000, -479.000000)" fill="#2E3C43">
                          <path d="M112.153937,491.166708 C112.051812,491.089375 111.928313,491.048292 111.80125,491.048292 L105.19875,491.048292 C105.072875,491.048292 104.948188,491.089375 104.846063,491.166708 C101.972313,493.323583 99,497.485083 99,500.714958 C99,505.660667 102.018625,507.964958 108.5,507.964958 C114.981375,507.964958 118,505.660667 118,500.714958 C118,497.483875 115.027687,493.322375 112.153937,491.166708 Z M108.5,506.756625 C101.1755,506.756625 100.1875,503.703167 100.1875,500.714958 C100.1875,497.959958 102.86175,494.226208 105.397063,492.256625 L111.604125,492.256625 C114.13825,494.226208 116.8125,497.95875 116.8125,500.714958 C116.8125,503.703167 115.8245,506.756625 108.5,506.756625 Z M109.09375,496.485792 C109.74925,496.485792 110.28125,497.028333 110.28125,497.694125 C110.28125,498.027625 110.54725,498.298292 110.875,498.298292 C111.20275,498.298292 111.46875,498.027625 111.46875,497.694125 C111.46875,496.571583 110.70875,495.632708 109.6875,495.36325 L109.6875,494.673292 C109.6875,494.339792 109.4215,494.069125 109.09375,494.069125 C108.766,494.069125 108.5,494.339792 108.5,494.673292 L108.5,495.36325 C107.47875,495.632708 106.71875,496.571583 106.71875,497.694125 C106.71875,499.026917 107.783938,500.110792 109.09375,500.110792 C109.74925,500.110792 110.28125,500.653333 110.28125,501.319125 C110.28125,501.984917 109.74925,502.527458 109.09375,502.527458 C108.43825,502.527458 107.90625,501.984917 107.90625,501.319125 C107.90625,500.985625 107.64025,500.714958 107.3125,500.714958 C106.98475,500.714958 106.71875,500.985625 106.71875,501.319125 C106.71875,502.441667 107.47875,503.380542 108.5,503.65 L108.5,504.339958 C108.5,504.673458 108.766,504.944125 109.09375,504.944125 C109.4215,504.944125 109.6875,504.673458 109.6875,504.339958 L109.6875,503.65 C110.70875,503.380542 111.46875,502.441667 111.46875,501.319125 C111.46875,499.986333 110.403562,498.902458 109.09375,498.902458 C108.43825,498.902458 107.90625,498.359917 107.90625,497.694125 C107.90625,497.028333 108.43825,496.485792 109.09375,496.485792 Z M104.34375,488.631625 C104.016,488.631625 103.75,488.902292 103.75,489.235792 C103.75,489.569292 104.016,489.839958 104.34375,489.839958 L112.65625,489.839958 C112.984,489.839958 113.25,489.569292 113.25,489.235792 C113.25,488.902292 112.984,488.631625 112.65625,488.631625 L104.34375,488.631625 Z M104.9375,486.819125 C104.9375,487.152625 105.2035,487.423292 105.53125,487.423292 L111.46875,487.423292 C111.7965,487.423292 112.0625,487.152625 112.0625,486.819125 C112.0625,484.615125 114.314,481.147208 114.33775,481.112167 C114.483812,480.889833 114.467187,480.596208 114.29975,480.390792 C114.132312,480.185375 113.8485,480.1165 113.609812,480.221625 L110.014062,481.790042 L109.051,479.344375 C108.872875,478.885208 108.128312,478.885208 107.949,479.344375 L106.985937,481.790042 L103.390187,480.222833 C103.149125,480.117708 102.867687,480.186583 102.70025,480.392 C102.532812,480.596208 102.516187,480.889833 102.66225,481.112167 C102.686,481.147208 104.9375,484.615125 104.9375,486.819125 Z M107.078562,483.144583 C107.227,483.208625 107.392062,483.209833 107.5405,483.147 C107.68775,483.084167 107.805312,482.964542 107.8635,482.8135 L108.5,481.195542 L109.1365,482.8135 C109.195875,482.964542 109.31225,483.085375 109.4595,483.147 C109.607937,483.208625 109.773,483.207417 109.921437,483.144583 L112.410437,482.0595 C111.800062,483.218292 111.087562,484.8145 110.914187,486.214958 L106.085812,486.214958 C105.912437,484.8145 105.199937,483.2195 104.589562,482.0595 L107.078562,483.144583 Z" id="money"></path>
                      </g>
                  </g>
              </svg>
              <!-- gender -->
              <svg class="gender" style="display: none;" width="27px" height="29px" viewBox="0 0 27 29" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                  <defs></defs>
                  <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                      <g id="-Icons" transform="translate(-57.000000, -298.000000)" fill="#000000">
                          <path d="M69.28875,306.666101 C69.0225,306.44951 68.63,306.487444 68.40875,306.74564 C68.18875,307.006284 68.225,307.391744 68.49,307.607111 C69.92625,308.774503 70.75,310.491326 70.75,312.315834 C70.75,315.689521 67.94625,318.434236 64.5,318.434236 C61.05375,318.434236 58.25,315.689521 58.25,312.315834 C58.25,309.12937 60.69125,306.50947 63.9275,306.223129 C64.27125,306.192537 64.525,305.893959 64.49375,305.55867 C64.46375,305.220934 64.1525,304.968856 63.815,305.003119 C59.93,305.349421 57,308.491832 57,312.315834 C57,315.946494 59.70875,318.962866 63.25,319.547786 L63.25,323.328958 L61.375,323.328958 C61.03,323.328958 60.75,323.603063 60.75,323.940799 C60.75,324.278535 61.03,324.552639 61.375,324.552639 L63.25,324.552639 L63.25,326.38816 C63.25,326.725896 63.53,327 63.875,327 C64.22,327 64.5,326.725896 64.5,326.38816 L64.5,324.552639 L66.375,324.552639 C66.72,324.552639 67,324.278535 67,323.940799 C67,323.603063 66.72,323.328958 66.375,323.328958 L64.5,323.328958 L64.5,319.657917 C68.63625,319.657917 72,316.364993 72,312.315834 C72,310.125446 71.01125,308.065992 69.28875,306.666101 Z M83.95125,298.368655 C83.88875,298.222382 83.76625,298.10584 83.6125,298.046379 C83.5375,298.01546 83.45625,298 83.375,298 L78.375,298 C78.03,298 77.75,298.266383 77.75,298.594605 C77.75,298.922827 78.03,299.189209 78.375,299.189209 L81.86625,299.189209 L76.3375,304.449083 C75.03125,303.395443 73.34375,302.756838 71.5,302.756838 C67.36375,302.756838 64,305.957001 64,309.892095 C64,312.030294 64.995,314.03649 66.73,315.398135 C66.9975,315.607436 67.39125,315.57057 67.61,315.318458 C67.83,315.065156 67.7925,314.690555 67.52625,314.481254 C66.08,313.345559 65.25,311.673531 65.25,309.892095 C65.25,306.613444 68.05375,303.946047 71.5,303.946047 C74.94625,303.946047 77.75,306.613444 77.75,309.892095 C77.75,312.988796 75.31,315.533705 72.07375,315.813169 C71.73,315.84171 71.47625,316.131877 71.5075,316.45891 C71.53625,316.768104 71.81,317 72.13,317 C72.14875,317 72.1675,317 72.18625,316.997622 C76.07125,316.662265 79,313.608375 79,309.892095 C79,308.138011 78.32875,306.532578 77.22125,305.289854 L82.75,300.029981 L82.75,303.351443 C82.75,303.679665 83.03,303.946047 83.375,303.946047 C83.72,303.946047 84,303.679665 84,303.351443 L84,298.594605 C84,298.518495 83.98375,298.440008 83.95125,298.368655 Z" id="Combined-Shape"></path>
                      </g>
                  </g>
              </svg>
              <!-- ethnicity -->
              <svg class="ethnicity" style="display: none;" width="27px" height="29px" viewBox="0 0 27 29" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                  <defs></defs>
                  <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                      <g id="-Icons" transform="translate(-57.000000, -364.000000)" fill="#000000">
                          <path d="M82.224649,375.909333 C81.8515953,375.276167 81.3417552,374.406167 81.3280766,374.15725 C81.326833,367.800208 75.2808758,364 69.435124,364 C62.46275,364 57,369.340833 57,376.15825 C57,380.50825 58.6725242,383.74175 61.9740496,385.774167 L61.9740496,392.395833 C61.9740496,392.729333 62.2525964,393 62.5958058,393 L75.0309298,393 C75.3741392,393 75.652686,392.729333 75.652686,392.395833 L75.652686,388.797417 C77.812667,388.776875 79.1195985,388.561792 80.0945123,387.612042 C81.1328451,386.603083 81.2820666,383.576208 81.2907712,382.140708 C81.6675554,382.14675 82.1413337,382.147958 82.5554233,382.13225 C83.0379061,382.1105 83.4855706,381.876083 83.7516822,381.503917 C83.9829755,381.184917 83.9854625,380.849 83.9879496,380.606125 L83.9929236,380.438167 C84.0936481,379.090875 83.1000817,377.401625 82.224649,375.909333 L82.224649,375.909333 Z M82.988525,380.626864 C82.988525,380.704182 82.9872568,380.820773 82.9771112,380.847773 C82.9314562,380.910364 82.8338051,380.957 82.7412268,380.961909 C81.9486046,380.992591 80.8985387,380.954545 80.8921977,380.954545 C80.7133821,380.939818 80.5472485,381.011 80.4229654,381.130045 C80.2986822,381.250318 80.2301996,381.412318 80.2340042,381.581682 C80.2758547,383.405409 80.0425067,386.255136 79.3881178,386.887182 C78.7273879,387.527818 77.7496092,387.734 75.3692061,387.734 L75.1244444,387.732773 L75.121908,387.732773 C74.9545062,387.732773 74.7934454,387.796591 74.674235,387.911955 C74.5537564,388.027318 74.486542,388.183182 74.486542,388.346409 L74.486542,392 L63.0727822,392 L63.0727822,385.544545 C63.0727822,385.327318 62.95484,385.127273 62.7620743,385.016818 C59.601731,383.204136 58,380.210818 58,376.121545 C58,369.884545 63.013177,365 69.4137599,365 C74.7515949,365 80.2733183,368.400773 80.2733183,374.089182 C80.2733183,374.619364 80.6639225,375.306636 81.3550891,376.477455 C82.0779606,377.704727 83.0696895,379.383636 82.9961341,380.380182 C82.9910613,380.463636 82.9897931,380.545864 82.988525,380.626864 L82.988525,380.626864 Z" id="Shape"></path>
                      </g>
                  </g>
              </svg>
              <!-- workandcommuting-->
              <svg class="workandcommuting" style="display: none;" width="24px" height="21px" viewBox="0 0 24 21" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                  <defs></defs>
                  <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                      <g id="-Icons" transform="translate(-59.000000, -431.000000)" fill="#000000">
                          <path d="M80.5,435 L76,435 L76,434.5 C76,432.57 74.43,431 72.5,431 L69.5,431 C67.57,431 66,432.57 66,434.5 L66,435 L61.5,435 C60.121,435 59,436.122 59,437.5 L59,445.5 C59,445.776 59.224,446 59.5,446 L60,446 L60,451.5 C60,451.776 60.224,452 60.5,452 L81.5,452 C81.776,452 82,451.776 82,451.5 L82,446 L82.5,446 C82.776,446 83,445.776 83,445.5 L83,437.5 C83,436.122 81.879,435 80.5,435 L80.5,435 Z M67,434.5 C67,433.122 68.121,432 69.5,432 L72.5,432 C73.879,432 75,433.122 75,434.5 L75,435 L67,435 L67,434.5 L67,434.5 Z M81,451 L61,451 L61,446 L68,446 L68,446.5 C68,446.776 68.224,447 68.5,447 L73.5,447 C73.776,447 74,446.776 74,446.5 L74,446 L81,446 L81,451 L81,451 Z M69,446 L69,444 L73,444 L73,446 L69,446 L69,446 Z M82,445 L81.5,445 L74,445 L74,443.5 C74,443.224 73.776,443 73.5,443 L68.5,443 C68.224,443 68,443.224 68,443.5 L68,445 L60.5,445 L60,445 L60,437.5 C60,436.673 60.673,436 61.5,436 L66.5,436 L75.5,436 L80.5,436 C81.327,436 82,436.673 82,437.5 L82,445 L82,445 Z" id="Shape"></path>
                      </g>
                  </g>
              </svg>
            </div>
            <h3 class="box-figure js-figure">256,982</h3>
            <p class="box-figureInfo"><span class="js-percent">45</span>% of total (<span class="js-total">545,065</span>)</p>
          </div>
        </div>
      </div>
      <div class="box-container is-hidden">
        <nav class="box-nav"></nav>
        <div class="box-result">
      </div>
    </div>
  </div>
  <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

  <script type="text/javascript">
    var sublayer;

    var maxHeightList = function(){
      var heightScreen = $(window).height();
      var heightNavigation = 86;
      var heightHeader = $('.box-header').height();
      var maxHeightScroll = (heightScreen) - (40 + heightNavigation + heightHeader) - 64;
      $('.box-resultList').css('max-height', maxHeightScroll);
    };

    $( document ).ready(function() {
      var selected_column = 'total_pop'
      var selected_agg_type = 'sum'
      cartodb.createVis('map', 'https://observatory.cartodb.com/api/v2/viz/b28e2a62-1b75-11e6-bad5-0e5db1731f59/viz.json')
        .done(function(map,layers){
          sublayer = layers[1].getSubLayer(0);

          var nativeMap = map.getNativeMap()
          var table_name = 'observatory_blogpost_hero'
          var sql = new cartodb.SQL({ user: 'observatory' });
          
          var updateStats= function(){
            column_name = selected_column
            bounds = nativeMap.getBounds()
            if (selected_agg_type=='sum'){
              query = "SELECT sum({{column_name}}) AS total_value, \
                          sum( CASE WHEN the_geom && ST_MakeEnvelope({{bounds}}, 4326) THEN {{column_name}} ELSE 0 END )  AS value\
                          FROM {{table_name}} "
            }
            else if (selected_agg_type=='avg'){
              query = "with avg_total as(\
                        select avg({{column_name}}) as total from {{table_name}} \
                      )\
                      SELECT avg({{column_name}}) AS value, \
                          avg_total.total as total_value \
                          FROM {{table_name}}, avg_total \
                          where \
                        {{table_name}}.the_geom && ST_MakeEnvelope({{bounds}}, 4326) \
                        group by avg_total.total"
            }
            sql.execute(query, {  
              column_name: column_name, 
              table_name: table_name,
              agg_type: selected_agg_type,
              bounds: [bounds.getNorthEast().lng, bounds.getNorthEast().lat, bounds.getSouthWest().lng, bounds.getSouthWest().lat].join(',')
            })
              .done(function(data) {
                $(".js-figure").text(Math.floor(data.rows[0].value));
                $(".js-percent").text(Math.floor(data.rows[0].value*100.0/data.rows[0].total_value));
                $(".js-total").text(Math.floor(data.rows[0].total_value));
            })
          }
          
          nativeMap.on('move', updateStats.bind(this))

          /* read json */
          var subitemsMenu = function(e,f){
            var id = $(e).attr("data-value");
            var obj = f[id];
            var j = obj.filter_1;
            var subitems = [];
            $.each( j, function( k, val ) {
              subitems.push( "<li><a href='#' data-agg='"+val.type+"' data-col='"+val.data_col+"' data-value='" + val.value + "'>" + val.label_1 + "</a></li>" );
            });

            $( ".js-result-category" ).empty();
            $( ".box-result" ).empty();
            $( "<ul/>", {
              "class": "box-resultList js-result-category",
              html: subitems.join( "" ),
            }).appendTo(".box-result");
            maxHeightList();
          };

          var clickSubitem = function(){
            $( ".js-result-category li a" ).on( "click", function() {
              $(".js-result-category li a").removeClass( "is-selected" );
              $(this).toggleClass( "is-selected" );
              $(".js-box-selectTitle").text($(this).text());
            
              var column_name = $(this).attr('data-col')
              sublayer.setSQL('with stats as( select max('+column_name+'), min('+column_name+') from '+table_name+')\
                                                          select the_geom_webmercator, ('+column_name+'-stats.min)/(stats.max-stats.min) as val from stats, ' +table_name);

              var css = sublayer.getCartoCSS();
              sublayer.setCartoCSS(css);
              
              selected_column    = $(this).attr('data-col')
              selected_agg_type  = $(this).attr('data-agg')
              updateStats();                                        
              
              
            });
          };
          var scrollFunction = function(){
            $(".js-result-category").niceScroll({
              cursorcolor: "#ccc", // change cursor color in hex
              cursorwidth: "4px"
            });
          };
          $.getJSON( "data.json", function( data ) {
            var items = [];
            $.each( data, function( key, val ) {
                if (items.length == 0) {
                  items.push( "<li><a class='is-selected' href='#'  data-value='" + key + "'>" + val.label + "</a></li>" );
                } else {
                  items.push( "<li><a href='#' data-value='" + key + "'>" + val.label + "</a></li>" );
                }     
            });
            $( "<ul/>", {
              "class": "box-navNavigation",
              html: items.join( "" )
            }).appendTo( ".box-nav" );
            subitemsMenu($( ".box-navNavigation a" ), data);
          })
            .done(function(data){
              $( ".box-navNavigation a" ).on( "click", function() {
                var txt = $(this).text();
                $(".js-box-input").text(txt);
                $(".box-navNavigation a").removeClass( "is-selected" );
                $(this).toggleClass( "is-selected" );
                subitemsMenu(this, data);
                clickSubitem();
                scrollFunction();
                $( ".box-icon svg" ).hide();
                  var txtDown = $(this).text();
                  txtDown = txtDown.toLowerCase();
                  var dest = txtDown;
                  dest = dest.split(" ").join("");
                  if($( ".box-icon svg" ).hasClass(dest)) {
                    $( ".box-icon svg."+dest ).show();
                  }
              });
              clickSubitem();
              scrollFunction();
            })


          $( ".box-input" ).on( "click", function() {
            $(this).toggleClass( "is-open" );
            maxHeightList();
            $(".box-container").toggleClass( "is-hidden" );
          });
        })
        

        

    });

  </script>

</body>

</html>
